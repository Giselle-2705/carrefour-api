name: Maven CI/CD - API Automation Tests

# Triggers: quando executar
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permite execuÃ§Ã£o manual

# Jobs: etapas do workflow
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Timeout de 15 min

    # Environment variables globais
    env:
      MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
      JAVA_OPTS: "-Xmx2048m"

    steps:
    # 1. Checkout do cÃ³digo
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Para commits anteriores (Allure history)

    # 2. Setup Java 17
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'  # Cache automÃ¡tico do Maven

    # 3. Cache Maven (acelera builds)
    - name: ğŸ“¦ Cache Maven Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    # 4. Verificar cÃ³digo
    - name: ğŸ” Code Quality Check
      run: |
        echo "ğŸ“‹ Verificando estrutura do projeto..."
        ls -la
        cat pom.xml | head -20
        find src -name "*.java" | head -5
        echo "âœ… Estrutura OK"

    # 5. Compilar projeto
    - name: ğŸ”¨ Maven Build
      run: |
        echo "ğŸ—ï¸ Compilando projeto..."
        mvn -B clean compile -DskipTests
        echo "âœ… Build concluÃ­do com sucesso!"

    # 6. Executar testes
    - name: ğŸ§ª Run Unit Tests
      run: |
        echo "ğŸš€ Executando testes automatizados..."
        mvn -B test surefire-report:report
        echo "ğŸ“Š Testes executados!"
        echo "Resultados:"
        cat target/surefire-reports/TEST-*.xml | grep -E "(tests|failures|errors)" || echo "Sem relatÃ³rios XML"

    # 7. Verificar cobertura (opcional)
    - name: ğŸ“ˆ Code Coverage (Jacoco)
      if: success()
      run: |
        echo "ğŸ“Š Gerando relatÃ³rio de cobertura..."
        mvn jacoco:report || echo "âš ï¸ Jacoco opcional"
        echo "âœ… Cobertura gerada em: target/site/jacoco/"

    # 8. Gerar relatÃ³rios detalhados
    - name: ğŸ“‹ Generate Detailed Reports
      if: always()
      run: |
        echo "ğŸ“ˆ Gerando relatÃ³rios avanÃ§ados..."
        # Surefire Reports (HTML)
        mvn surefire-report:report || echo "âš ï¸ Surefire report opcional"
        # Preparar Allure (simples)
        mkdir -p allure-results
        find . -name "*.xml" -path "*/surefire-reports/*.xml" -exec cp {} allure-results/ \; 2>/dev/null || true
        # Listar relatÃ³rios gerados
        echo "ğŸ“ RelatÃ³rios disponÃ­veis:"
        ls -la target/surefire-reports/ 2>/dev/null || echo "Sem Surefire reports"
        ls -la target/site/ 2>/dev/null || echo "Sem Maven site"
        ls -la allure-results/ 2>/dev/null || echo "Sem Allure results"

    # 9. Publicar resultados dos testes
    - name: ğŸ“Š Publish Test Results
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: "ğŸ§ª JUnit Test Results"
        path: "**/surefire-reports/TEST-*.xml"
        reporter: java-junit
        fail-on-error: false
        list-tests: true
        list-failed-tests: true

    # 10. Upload de artefatos (relatÃ³rios)
    - name: ğŸ“¤ Upload Test Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: "test-reports-${{ github.run_number }}"
        path: |
          target/surefire-reports/
          target/site/
          target/jacoco/
          allure-results/
        retention-days: 30
        compression-level: 6

    # 11. NotificaÃ§Ã£o de sucesso
    - name: ğŸ‰ Build Success
      if: success()
      run: |
        echo "ğŸ‰ Todos os testes passaram com sucesso! âœ…"
        echo "ğŸ“Š Total de testes executados com sucesso"
        echo "ğŸ“ˆ RelatÃ³rios disponÃ­veis nos artefatos acima"
        echo "ğŸ”— Pipeline: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

    # 12. NotificaÃ§Ã£o de falha
    - name: ğŸš¨ Build Failed
      if: failure()
      run: |
        echo "âŒ Falha na execuÃ§Ã£o dos testes! ğŸ”"
        echo "ğŸ“Š Verifique os logs acima para detalhes dos erros"
        echo "ğŸ“ Baixe os artefatos para anÃ¡lise detalhada"
        echo "ğŸ”— Pipeline: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        exit 1

  # Job adicional: Deploy (opcional - sÃ³ em main)
  deploy:
    needs: build-and-test  # SÃ³ executa se testes passarem
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - name: ğŸš€ Notify Deployment Ready
      run: |
        echo "ğŸš€ Deploy para produÃ§Ã£o estÃ¡ pronto!"
        echo "âœ… Todos os testes passaram na branch main"
        echo "ğŸ“… Data/Hora: $(date)"
        echo "ğŸ‘¤ Autor: ${{ github.actor }}"
        echo "ğŸ’¬ Commit: ${{ github.event.head_commit.message }}"
